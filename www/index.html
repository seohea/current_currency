<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=0.5, maximum-scale=0.5, width=device-width" />
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href='https://fonts.googleapis.com/css?family=Lato:300' rel='stylesheet' type='text/css'>
        <script type="text/javascript" src="https://www.google.com/jsapi" ></script>

        <style type="text/css">
            body{
                min-height: 100%;
                -webkit-text-size-adjust: none;             /* prevent webkit from resizing text to fit */
                font-family: 'Lato', sans-serif;
            }

            .navbar-header {
                float: left;
                padding: 15px;
                text-align: center;
                width: 100%;

            }
            .navbar-brand {
                float:none;
                font-size: 14px;
            }

            .input_newstyle{
                -webkit-appearance: none;
                border: 0px;
                border: none;
                border-radius: 5px;
                font-size: 28px;
                background-color: rgba(0,0,0,0);
                width: 100%;
            }
            .left{
                float:left;
                margin-left: 20px;
                max-width: 45%;
            }
            .right{
                float:right;
                padding-right: 20px;
                max-width: 45%;
            }

            .dollar_sign{
                font-size: 28px;
                margin-right: 5px;
            }

            .country_code{
                font-size: 24px;
            }

            .country_code_detail{
                font-size: 11px;
                letter-spacing: 0px;
                display: block;
                color:grey;
            }

            #chartModaltitle{
                font-size: 13px;
            }

            #target_panel{
                color: black;
                /*border-color: #0099ff;*/
            }

            .myPanel{
                /*box-shadow: 0 1px 1px rgba(0,0,0,0.19), 0 1px 1px rgba(0,0,0,0.23);*/
                margin: 5px 0px;
            }

            .panel{
                border-radius: 0px;
            }

            .panel-body{
                padding: 8px 2px;
            }

            .flag{
                border-radius: 50%;
                border: 0px;
                margin-left: 10px;
                padding: 0px;
                width: 40px;
                height: 40px; 
            }

            #tiles{
                margin-bottom: 60px;
                width: 100%;
                overflow: hidden;
            }

            #loading{
                text-align: center;
                display: none;
                color:#4d4d4d;
                padding-bottom: 50px;
            }

            .moveanimation {-webkit-animation: anim1 ease-in-out 1s infinite alternate; }
            @-webkit-keyframes anim1
            {
               from {-webkit-transform: rotate(0deg); }
               to   {-webkit-transform: rotate(720deg); }
            }

            .borderBlink{    
                border:1px solid;
            }


            .splashanimation {-webkit-animation: anim2 ease-in-out 0.5s infinite alternate; }
            @-webkit-keyframes anim2
            {
               from {border-color: transparent; }
               to   {border-color: #a6a6a6; }
            }

            .modal-header{
                background-color: black;
                color:white;
                border-bottom: 0px;
                box-shadow: 0 1px 1px rgba(0,0,0,0.19), 0 1px 1px rgba(0,0,0,0.23);
            }

            .divider {
                width:100%;
                text-align:center;
            }

            .divider hr {
                margin-left:auto;
                margin-right:auto;
                width:40%;
            }

            .hrleft { float:left; }
            .hrright { float:right; }
            .hrdown{ font-size: 16px; padding-top: 10px; }

            .flag:hover, .flag:focus, .flag:active { outline: none !important;} .flag { outline: none; }
            .input:hover, .input:focus, .input:active { outline: none !important;} .input { outline: none; }

        </style>

        <title>Currency</title>

        <script src="js/jquery.js"></script>
        <script src="js/bootstrap.min.js"></script>

        <script type="text/javascript">
            var allrates;
            var counter;
            var allrates_history = [];
            var mycurrencycountries = [];
            var mycurrencycountry;
            var last_draw_date;
            var countries = {   
                                "AUD":"Australian dollar",
                                "BGN":"Bulgarian lev",
                                "BRL":"Brazilian real",
                                "CAD":"Canadian dollar",
                                "CHF":"Swiss franc",
                                "CNY":"Chinese Yuan",
                                "CZK":"Czech koruna",
                                "DKK":"Danish krone",
                                "EUR":"Euro",
                                "GBP":"Pound sterling",
                                "HKD":"Hong Kong Dollar",
                                "HRK":"Croatian kuna",
                                "HUF":"Hungarian forint",
                                "IDR":"Indonesian rupiah",
                                "ILS":"Israeli new shekel",
                                "INR":"Indian rupee",
                                "JPY":"Japanese Yen",
                                "KRW":"S.Korean Won",
                                "MXN":"Mexican peso",
                                "MYR":"Malaysian ringgit",
                                "NOK":"Norwegian krone",
                                "NZD":"New Zealand dollar",
                                "PHP":"Philippine peso",
                                "PLN":"Polish złoty",
                                "RON":"Romanian leu",
                                "RUB":"Russian ruble",
                                "SEK":"Swedish krona",
                                "SGD":"Singapore dollar",
                                "THB":"Thai baht",
                                "TRY":"Turkish lira",
                                "USD":"US Dollar",
                                "ZAR":"South African rand"
                            };
            var countries_sign = {   
                                "AUD":"$",
                                "BGN":"лв",
                                "BRL":"$",
                                "CAD":"$",
                                "CHF":"Fr",
                                "CNY":"$",
                                "CZK":"Kč",
                                "DKK":"Kr",
                                "EUR":"€",
                                "GBP":"$", 
                                "HKD":"$",
                                "HRK":"Kn",
                                "HUF":"Ft",
                                "IDR":"Rp",
                                "ILS":"₪",
                                "INR":"₹",
                                "JPY":"¥",
                                "KRW":"₩",
                                "MXN":"$",
                                "MYR":"RM",
                                "NOK":"kr",
                                "NZD":"$",
                                "PHP":"₱",
                                "PLN":"zł",
                                "RON":"$",
                                "RUB":"₽",
                                "SEK":"kr",
                                "SGD":"$",
                                "THB":"฿",
                                "TRY":"₺",
                                "USD":"$",
                                "ZAR":"R"
                            };


            $(document).ready(function() {
                //init_func();
            });

            function init_func(){
                get_history();
                gen_tiles();
                calTime();
                buffer_getSpecificData();
                tutorial();
                toLocalTime();
            }

            function tutorial(){
                $('body').animate({ scrollTop: 0 });
                $("#ifrom").attr('class','input_newstyle borderBlink splashanimation');
                setTimeout(function(){ 
                    $("#ifrom").attr('class','input_newstyle');
                }, 8000);
            }

            function toLocalTime(){
                var date = new Date(new Date(new Date(last_draw_date - 3600 * 1000)).toUTCString().replace( / GMT$/, " UTC" ));
                try{
                    $(".navbar-brand").text("Last updated: "+date.toString().split("GMT")[0]);
                }catch(excpetion){
                    $(".navbar-brand").text("Current Currency");
                }
                
            }

            function calTime() {
                var offset = 1;
                try{
                    var nowDate = new Date().getTime() + 3600 * 1000;

                    if (last_draw_date == null){
                        console.log("New comer.");
                        last_draw_date = nowDate;
                        getAllData();
                        toLocalTime();
                    }else if (Math.abs(last_draw_date - nowDate) / 36e5 >= 24 ){
                        console.log("Didn't draw > 24 hours: "+Math.abs(last_draw_date - nowDate));
                        last_draw_date = nowDate;
                        getAllData();
                        toLocalTime();
                    }else{
                        console.log("drawed within 24 hours!");
                        tobeConvert($("#ifrom").val());
                        country_select();
                    }

                }catch(err){}

            }



            function get_history(){
                var retrievedObject = localStorage.getItem('mycurrencycountries');
                mycurrencycountries = JSON.parse(retrievedObject);
                if (mycurrencycountries == null)
                    mycurrencycountries = [];

                mycurrencycountry = localStorage.getItem('mycurrencycountry');
                if (mycurrencycountry == null)
                    mycurrencycountry = "HKD";

                last_draw_date = localStorage.getItem('rate_last_draw_date');

                var retrievedObject2 = localStorage.getItem('rate_history_'+mycurrencycountry);
                allrates = JSON.parse(retrievedObject2);

            }

            function clear_history(){
                window.localStorage.clear();
                allrates = null;
                allrates_history = [];
                mycurrencycountries = [];
                last_draw_date = 0;

                get_history();
                gen_tiles();
                calTime();
                buffer_getSpecificData();
            }

            function add_history(){
                window.localStorage.removeItem("mycurrencycountries");
                window.localStorage.setItem("mycurrencycountries", JSON.stringify(mycurrencycountries));

                window.localStorage.removeItem("mycurrencycountry");
                window.localStorage.setItem("mycurrencycountry", mycurrencycountry);

                window.localStorage.removeItem("rate_last_draw_date");
                window.localStorage.setItem("rate_last_draw_date", last_draw_date);

                window.localStorage.removeItem("rate_history_"+mycurrencycountry);
                window.localStorage.setItem("rate_history_"+mycurrencycountry, JSON.stringify(allrates));
            }

            function gen_tiles(){
                $(".myPanel").remove();

                var template = $('#hidden-template').html();
                for(var i=0; i<mycurrencycountries.length; i++){
                    $("#tiles").append(template);
                }

                fill_tiles_id();

                $("#target_panel .country_code").text(mycurrencycountry);
                $("#target_panel .country_code_detail").text(countries[mycurrencycountry]);
                $("#target_panel .flag").css('background', 'url(img/'+mycurrencycountry+'.png) no-repeat center');
                $("#target_panel .flag").css('background-size', '180%');

                $("#target_panel .dollar_sign").text(countries_sign[mycurrencycountry]);
            }

            function fill_tiles_id(){
                $('#tiles').find('.myPanel').each(function (i) {
                    $(this).attr('id', 'tile_' + mycurrencycountries[i]);
                });
                
            }

            function tobeConvert(value){
                //var countries = ['USD', 'KRW'];
                for(var i=0; i<mycurrencycountries.length; i++){
                    convert(mycurrencycountries[i],value);
                }
                $(".myPanel").show();
            }

            function convert(country, value){
                var rate = allrates.rates[country];
                var result = (parseFloat(value)*parseFloat(rate)).toFixed(4).toString();
                if(isNaN(result)){
                    result = $("#target_panel .input_newstyle").val();
                }
                //$("#to"+country).val(result);
                $("#tile_"+country+" .input_newstyle").val(result);
                $("#tile_"+country+" .country_code").text(country);
                $("#tile_"+country+" .country_code_detail").text((countries[country])?countries[country]:"");
                
                $("#tile_"+country+" .flag").css('background', 'url(img/'+country+'.png) no-repeat center');
                $("#tile_"+country+" .flag").css('background-size', '180%');

                $("#tile_"+country+" .dollar_sign").text((countries_sign[country])?countries_sign[country]:"");
                

                //$('.input_newstyle').blur()
            }

            function add_country(value){
                mycurrencycountries.push(value);
                add_history();
                gen_tiles();
                tobeConvert($("#ifrom").val());
            }

            function setcountry(value){
                if(value == null || value == "")
                    value = "HKD";
                mycurrencycountry = value;

                add_history();
                gen_tiles(); 
                getAllData();
                buffer_getSpecificData();
            }

            function remove_country(value){
                var value = value.split("_")[1];

                mycurrencycountries.splice( $.inArray(value, mycurrencycountries), 1 );
                add_history();
                gen_tiles();
                tobeConvert($("#ifrom").val());
            }

            function country_select(){
                var options = '<option value="-" disabled selected> -- Please select -- </option>';
                for (var i = 0; i < Object.keys(countries).length; i++) {
                    options += '<option value="' + Object.keys(countries)[i]+ '">' + Object.keys(countries)[i]+" - "+ countries[Object.keys(countries)[i]] + '</option>';
                }
                $("#country_select").html(options);

                $("#set_country").html(options);
            }

            function getAllData(){

                $.ajax({
                    type : "Get",
                    url : 'http://api.fixer.io/latest?base='+mycurrencycountry,
                    success : function(data){
                        console.log(data);
                        allrates = data;

                        add_history();

                        tobeConvert($("#ifrom").val());
                        country_select();
                        /*
                        var options = '<option value="-default-" disabled selected> -- Please select -- </option>';
                        for (var i = 0; i <  Object.keys(allrates.rates).length; i++) {
                            options += '<option value="' + Object.keys(allrates.rates)[i]+ '">' + Object.keys(allrates.rates)[i] + '</option>';
                        }
                        $("#country_select").html(options);
                        */
                    },
                    error : function(httpReq,status,exception){
                        alert(status+" "+exception);
                    }
                });
            }


            function buffer_getSpecificData(){
                $("#loading").slideDown( 400, "linear" );
                counter = 6;
                allrates_history = [];
                var interval = $("#chartinterval").val();
                getSpecificData(interval);
            }

            function get_rates_history(date, base, interval){
                var retrievedObject = localStorage.getItem("ratehist_"+base+"_"+date);
                var data = JSON.parse(retrievedObject);
                if (retrievedObject == null){
                    console.log("Going to get: "+base+" "+date);
                    return true;
                }else{
                    allrates_history.push(data);
                    if(counter > 0){
                        counter--;
                        getSpecificData(interval);
                    }else{
                        $("#loading").slideUp( 800, "linear" );
                        $('body').animate({ scrollTop: 0 });
                    }
                    return false;
                }

            }

            function add_rates_history(obj){
                window.localStorage.setItem("ratehist_"+obj.base+"_"+obj.date, JSON.stringify(obj));
                console.log("Fetched and added new rates to sys. "+obj.base+" "+obj.date);
            }

            function getSpecificData(interval){
                var now = new Date();
                now.setDate(now.getDate()-counter*interval);
                var date = now.toISOString().slice(0,10);

                if(get_rates_history(date, mycurrencycountry, interval)){
                    
                    $.ajax({
                        type : "Get",
                        async: true,
                        url : 'http://api.fixer.io/'+date+'?base='+mycurrencycountry,
                        success : function(data){
                            data.date = date;

                            allrates_history.push(data);
                            add_rates_history(data)
                            
                            if(counter > 0){
                                counter--;
                                getSpecificData(interval);
                            }else{
                                $("#loading").slideUp( 800, "linear" );
                                $('body').animate({ scrollTop: 0 });
                            }
                        },
                        error : function(httpReq,status,exception){
                            alert(status+" "+exception);
                        }
                    });
                }
                
            }


            function openChart(value){
                $("#resultfig").html("");
                value = value.split("_")[1];

                $("#chartModaltitle").html("<span>"+countries[mycurrencycountry]+" ("+mycurrencycountry+")&nbsp;</span><span class='icon icon-right-nav' style='font-size:12px;'></span><span>&nbsp;"+countries[value]+" ("+value+")</span>");

                drawCurveTypes(value);
                $("#chartModal").modal('toggle');
            }

            google.load('visualization', '1', {packages: ['corechart', 'line']});

            function drawCurveTypes(value) {

                var newchart = new google.visualization.DataTable();
                newchart.addColumn('string', 'time');
                newchart.addColumn('number', 'rate');

                //newchart.addRows(mydata);
                //newchart.addRows([ ["test1",0.1],["test2",0.2],["test3",0.3]  ]);

                for(i = 0; i < allrates_history.length; i++){
                    newchart.addRow([allrates_history[i].date, parseFloat(allrates_history[i].rates[value])]);
                }

                var options = {
                  hAxis: {
                    showTextEvery: 0, 
                    slantedText: true, 
                    slantedTextAngle: 60
                  },
                  fontSize: 12,
                  pointsVisible: true,
                  pointSize: 3,
                  pointShape: 'circle',
                  'height':300,
                  'width':$(window).width()*0.82,
                  chartArea:{left:60,top:20,width:'90%',height:'70%'},
                  selectionMode: 'none',
                  curveType: 'function'
                };

                var chart = new google.visualization.LineChart(document.getElementById('resultchart'));
                chart.draw(newchart, options);
            }


            //------ADS
            
            function onDeviceReady() {

                /*
                admob.createBannerView({
                  publisherId:"ca-app-pub-9969581706012169/5605224331"
                });
*/
                
                document.addEventListener("resume", onResume, false);
                document.addEventListener("backbutton", onBackKeyDown, false);

                init_func();
                //initAds();
                //admob.createBannerView();
            }

            function onBackKeyDown() {
 
                if($('.modal').is(':visible')){
                    $('.modal').modal('hide');
                    return false;
                }else{
                    navigator.app.exitApp();
                    return false;
                }
                
            }

            function onResume() {

            }

            document.addEventListener("deviceready", onDeviceReady, false);
            

        </script>

    </head>

    <body>
        <!--div class="app">
            <h1>PhoneGap</h1>
            <div id="deviceready" class="blink">
                <p class="event listening">Connecting to Device</p>
                <p class="event received">Device is Ready</p>
            </div>
        </div-->

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-fixed-top" id="nav">
            <div class="navbar-header">
                <a class="navbar-brand">Current Currency</a>
            </div>
        </nav>

        <header>
            <div class="container" style="padding-top:80px;">
            </div>
        </header>

        <div class="container">
            <div class="row">
                <div id="loading"><br><span class="icon icon-refresh moveanimation" style="font-size:22px;"></span><br><p>Monkey is trying to gather Currency Rate <br> in the Sea of Internet...</p></div>
            </div>
        </div>

        <div class="container">

            <div class="panel panel-default" id="target_panel" >
                <div class="panel-body">
                    <div class="row">
                        <div class="left">
                            <table>
                                <tr>
                                    <td><span class="dollar_sign">$</span></td>
                                    <td><input type="number" class="input_newstyle" id="ifrom" oninput="tobeConvert(this.value);" value="1"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="right">
                            <table>
                                <tr>
                                    <td width="90"><span class="country_code"></span></td>
                                    <td rowspan="2"><button class="btn btn-default flag"></button></td>
                                </tr>
                                <tr>
                                    <td><span class="country_code_detail"></span></td>
                                </tr>
                            </table>
                        </div> 
                    </div>   
                          
                </div>
            </div>

            <div class="divider">
                <hr class="hrleft"/><span class="icon icon-down-nav hrdown"></span><hr class="hrright" />
            </div>

            <div id="tiles"></div>

        </div>

        <!-- aboutModal -->
        <div class="modal" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><span class="glyphicon glyphicon-remove"></span></span></button>
                <h4 class="modal-title" id="myModalLabel">關於</h4>
              </div>
              <div class="modal-body">
                <h4>Current Currency</h4>
                <ul>
                  <li>All right reserved &copy; Seohea Production</li>
                  <li>Version 0.1</li>
                </ul>
                <span style="font-size:12px;">Currecny rate last updated at GMT+3 15:00</span>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-success" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span>&nbsp;關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Add -->
        <div class="modal" id="addModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><span class="icon icon-close"></span></span></button>
                <h4 class="modal-title" id="myModalLabel">Add Country</h4>
              </div>
              <div class="modal-body">
                <select id="country_select"></select>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal" onclick="add_country($('#country_select').val());"><span class="icon icon-plus"></span></button>
              </div>
            </div>
          </div>
        </div>

        <!-- Set -->
        <div class="modal" id="setModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><span class="icon icon-close"></span></span></button>
                <h4 class="modal-title" id="myModalLabel">Set Country</h4>
              </div>
              <div class="modal-body">
                <p>Base Country:</p>
                <select id="set_country"></select>
                <button type="button" class="btn btn-primary btn-xs" data-dismiss="modal" onclick="setcountry($('#set_country').val());"><span class="icon icon-check"></span></button>
                <hr>
                <p>Chart interval:</p>
                <input type="number" id="chartinterval" value="7"><span>days</span>
                <button class="btn btn-default btn-xs" data-dismiss="modal" onclick="buffer_getSpecificData();"><span class="icon icon-check"></span></button>
              </div>
              <div class="modal-footer">
                
              </div>
            </div>
          </div>
        </div>

        <!-- chart -->
        <div class="modal" id="chartModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><span class="icon icon-close"></span></span></button>
                <h4 class="modal-title" id="chartModaltitle"></h4>
              </div>
              <div class="modal-body">
                <div id="resultchart" style="height:340px; width:100%; padding:0px; margin:0px; display:block;"></div>
              </div>
            </div>
          </div>
        </div>

        <nav class="navbar navbar-default navbar-fixed-bottom" id="bottomnav">
            <div class="container">
                <div class="btn-group btn-group-justified" role="group" aria-label="...">
                    <div class="btn-group" role="group">
                        <button class="btn btn-primary" type="button" data-toggle="modal" data-target="#addModal"><span class="icon icon-plus"></span></button>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-primary" type="button" data-toggle="modal" data-target="#setModal"><span class="icon icon-gear"></span></button>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-primary" type="button" onclick="clear_history();"><span class="icon icon-trash"></button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="tooltip top">
            <div class="tooltip-inner">
                Some tooltip text!
            </div>
            <div class="tooltip-arrow"></div>
        </div>

        <script id="hidden-template" type="text/x-custom-template">
            <div class="panel panel-default myPanel" style="display:none;" onclick="openChart($(this).closest('.panel').attr('id'));">
                <div class="panel-body">
                    <div class="row"> 
                        <div class="left">
                            <table>
                                <tr>
                                    <td><span class="dollar_sign">$</span></td>
                                    <td><input type="number" class="input_newstyle" disabled></td>
                                </tr>
                            </table>
                        </div>
                        <div class="right">
                            <table>
                                <tr>
                                    <td width="90"><span class="country_code"></span></td>
                                    <td rowspan="2"><button class="btn btn-default flag"></button></td>
                                </tr>
                                <tr>
                                    <td><span class="country_code_detail"></span></td>
                                </tr>
                            </table>
                        </div>
                    </div>                    
                </div>
            </div>
        </script>

        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript">
            app.initialize();
        </script>

    </body>
</html>
