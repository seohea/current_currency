<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=0.5, maximum-scale=0.5, width=device-width" />
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href='https://fonts.googleapis.com/css?family=Lato:300' rel='stylesheet' type='text/css'>
        <script type="text/javascript" src="https://www.google.com/jsapi" ></script>

        <style type="text/css">
            body{
                min-height: 100%;
                -webkit-text-size-adjust: none;             /* prevent webkit from resizing text to fit */
                font-family: 'Lato', sans-serif;
            }

            .navbar-header {
                float: left;
                padding: 15px;
                text-align: center;
                width: 100%;

            }
            .navbar-brand {
                float:none;
            }

            .input_newstyle{
                -webkit-appearance: none;
                border: 0px;
                border: none;
                font-size: 28px;
                background-color: rgba(0,0,0,0);
                width: 100%;
            }
            .left{
                float:left;
                margin-left: 20px;
                max-width: 50%;
            }
            .right{
                float:right;
                margin-right: 20px;
            }

            .dollar_sign{
                font-size: 28px;
                padding-right: 5px;
            }

            .country_code{
                font-size: 24px;
            }

            .country_code_detail{
                font-size: 11px;
                letter-spacing: 0px;
                display: block;
                color:grey;
            }

            #chartModaltitle{
                font-size: 13px;
            }

            #target_panel{
                color: black;
                /*border-color: #0099ff;*/
            }

            .myPanel{
                /*box-shadow: 0 1px 1px rgba(0,0,0,0.19), 0 1px 1px rgba(0,0,0,0.23);*/
                margin: 5px 0px;
            }

            .panel{
                border-radius: 0px;
            }

            .panel-body{
                padding: 8px 2px;
            }

            .flag{
                border-radius: 50%;
                border: 0px;
                margin-left: 10px;
                padding: 0px;
                width: 40px;
                height: 40px; 
            }

            #tiles{
                margin-bottom: 60px;
                width: 100%;
                overflow: scroll;
            }


            .flag:hover, .flag:focus, .flag:active { outline: none !important;} .flag { outline: none; }
            .input:hover, .input:focus, .input:active { outline: none !important;} .input { outline: none; }

        </style>

        <title>Currency</title>

        <script src="js/jquery.js"></script>
        <script src="js/bootstrap.min.js"></script>

        <script type="text/javascript">
            var allrates;
            var counter;
            var allrates_history = [];
            var mycurrencycountries = [];
            var mycurrencycountry;
            var countries = {   
                                "AUD":"Australian dollar",
                                "BGN":"Bulgarian lev",
                                "BRL":"Brazilian real",
                                "CAD":"Canadian dollar",
                                "CHF":"Swiss franc",
                                "CNY":"Chinese Yuan",
                                "CZK":"Czech koruna",
                                "DKK":"Danish krone",
                                "EUR":"Euro",
                                "GBP":"Pound sterling",
                                "HKD":"Hong Kong Dollar",
                                "HRK":"Croatian kuna",
                                "HUF":"Hungarian forint",
                                "IDR":"Indonesian rupiah",
                                "ILS":"Israeli new shekel",
                                "INR":"Indian rupee",
                                "JPY":"Japanese Yen",
                                "KRW":"South Korean Won",
                                "MXN":"Mexican peso",
                                "MYR":"Malaysian ringgit",
                                "NOK":"Norwegian krone",
                                "NZD":"New Zealand dollar",
                                "PHP":"Philippine peso",
                                "PLN":"Polish złoty",
                                "RON":"Romanian leu",
                                "RUB":"Russian ruble",
                                "SEK":"Swedish krona",
                                "SGD":"Singapore dollar",
                                "THB":"Thai baht",
                                "TRY":"Turkish lira",
                                "USD":"US Dollar",
                                "ZAR":"South African rand"
                            };


            $(document).ready(function() {
                get_history();
                gen_tiles();
                getAllData();

            });

            function get_history(){
                var retrievedObject = localStorage.getItem('mycurrencycountries');
                mycurrencycountries = JSON.parse(retrievedObject);
                if (mycurrencycountries == null)
                    mycurrencycountries = [];

                mycurrencycountry = localStorage.getItem('mycurrencycountry');
                if (mycurrencycountry == null)
                    mycurrencycountry = "HKD";
            }

            function clear_history(){
                window.localStorage.removeItem("mycurrencycountries");
                mycurrencycountries = [];
                gen_tiles();
            }

            function add_history(){
                window.localStorage.removeItem("mycurrencycountries");
                window.localStorage.setItem("mycurrencycountries", JSON.stringify(mycurrencycountries));

                window.localStorage.removeItem("mycurrencycountry");
                window.localStorage.setItem("mycurrencycountry", mycurrencycountry);
            }

            function gen_tiles(){
                $(".myPanel").remove();

                var template = $('#hidden-template').html();
                for(var i=0; i<mycurrencycountries.length; i++){
                    $("#tiles").append(template);
                }

                fill_tiles_id();

                $("#target_panel .country_code").text(mycurrencycountry);
                $("#target_panel .country_code_detail").text(countries[mycurrencycountry]);
                $("#target_panel .flag").css('background', 'url(img/'+mycurrencycountry+'.gif) no-repeat center');
                $("#target_panel .flag").css('background-size', '180%');
            }

            function fill_tiles_id(){
                $('#tiles').find('.myPanel').each(function (i) {
                    $(this).attr('id', 'tile_' + mycurrencycountries[i]);
                });
                
            }

            function tobeConvert(value){
                //var countries = ['USD', 'KRW'];
                for(var i=0; i<mycurrencycountries.length; i++){
                    convert(mycurrencycountries[i],value);
                }
                $(".myPanel").show();
            }

            function convert(country, value){
                var rate = allrates.rates[country];
                var result = (parseFloat(value)*parseFloat(rate)).toFixed(4).toString();
                if(isNaN(result)){
                    result = $("#target_panel .input_newstyle").val();
                }
                //$("#to"+country).val(result);
                $("#tile_"+country+" .input_newstyle").val(result);
                $("#tile_"+country+" .country_code").text(country);
                $("#tile_"+country+" .country_code_detail").text((countries[country])?countries[country]:"");
                /*
                $("#tile_"+country+" .flag").css('background', 'url(img/'+country+'.png) no-repeat center');
                $("#tile_"+country+" .flag").css('background-size', '180%');
                */

                //$('.input_newstyle').blur()
            }

            function add_country(value){
                mycurrencycountries.push(value);
                add_history();
                gen_tiles();
                tobeConvert($("#ifrom").val());
            }

            function setcountry(value){
                if(value == null || value == "")
                    value = "HKD";
                mycurrencycountry = value;

                add_history();
                gen_tiles(); 
                getAllData();
            }

            function remove_country(value){
                var value = value.split("_")[1];

                mycurrencycountries.splice( $.inArray(value, mycurrencycountries), 1 );
                add_history();
                gen_tiles();
                tobeConvert($("#ifrom").val());
            }

            function country_select(){
                var options = '<option value="-" disabled selected> -- Please select -- </option>';
                for (var i = 0; i < Object.keys(countries).length; i++) {
                    options += '<option value="' + Object.keys(countries)[i]+ '">' + Object.keys(countries)[i]+" - "+ countries[Object.keys(countries)[i]] + '</option>';
                }
                $("#country_select").html(options);

                $("#set_country").html(options);
            }

            function getAllData(){

                $.ajax({
                    type : "Get",
                    url : 'http://api.fixer.io/latest?base='+mycurrencycountry,
                    success : function(data){
                        console.log(data);
                        allrates = data;

                        tobeConvert($("#ifrom").val());
                        country_select();
                        /*
                        var options = '<option value="-default-" disabled selected> -- Please select -- </option>';
                        for (var i = 0; i <  Object.keys(allrates.rates).length; i++) {
                            options += '<option value="' + Object.keys(allrates.rates)[i]+ '">' + Object.keys(allrates.rates)[i] + '</option>';
                        }
                        $("#country_select").html(options);
                        */
                    },
                    error : function(httpReq,status,exception){
                        alert(status+" "+exception);
                    }
                });
            }


            function buffer_getSpecificData(){
                counter = 6;
                allrates_history = [];
                 getSpecificData();
            }

            function getSpecificData(){
                var now = new Date();
                var interval = $("#chartinterval").val();
                now.setDate(now.getDate()-counter*interval);
                var date = now.toISOString().slice(0,10);
                
                $.ajax({
                    type : "Get",
                    async: true,
                    url : 'http://api.fixer.io/'+date+'?base='+mycurrencycountry,
                    success : function(data){
                        allrates_history.push(data);
                        
                        if(counter > 0){
                            counter--;
                            getSpecificData();
                        }else{
                            alert("done");
                        }
                    },
                    error : function(httpReq,status,exception){
                        alert(status+" "+exception);
                    }
                });
                
            }


            function openChart(value){
                $("#resultfig").html("");
                value = value.split("_")[1];

                $("#chartModaltitle").html("<span>"+countries[mycurrencycountry]+" ("+mycurrencycountry+")&nbsp;</span><span class='icon icon-right-nav' style='font-size:12px;'></span><span>&nbsp;"+countries[value]+" ("+value+")</span>");

                drawCurveTypes(value);
                $("#chartModal").modal('toggle');
            }

            google.load('visualization', '1', {packages: ['corechart', 'line']});

            function drawCurveTypes(value) {

                var newchart = new google.visualization.DataTable();
                newchart.addColumn('string', 'time');
                newchart.addColumn('number', 'rate');

                //newchart.addRows(mydata);
                //newchart.addRows([ ["test1",0.1],["test2",0.2],["test3",0.3]  ]);

                for(i = 0; i < allrates_history.length; i++){
                    newchart.addRow([allrates_history[i].date, parseFloat(allrates_history[i].rates[value])]);
                }

                var options = {
                  hAxis: {
                    showTextEvery: 0, 
                    slantedText: true, 
                    slantedTextAngle: 60
                  },
                  fontSize: 12,
                  pointsVisible: true,
                  pointSize: 3,
                  pointShape: 'circle',
                  'height':300,
                  'width':$(window).width()*0.82,
                  chartArea:{left:60,top:20,width:'90%',height:'70%'},
                  selectionMode: 'none',
                  tooltip: {trigger: 'none'}
                };

                var chart = new google.visualization.LineChart(document.getElementById('resultchart'));
                chart.draw(newchart, options);
            }


            //------ADS
            
            function onDeviceReady() {
              admob.createBannerView({
                  publisherId:"ca-app-pub-9969581706012169/7609471531"
              });
            }
            
            document.addEventListener("deviceready", onDeviceReady, false);
            

        </script>

    </head>

    <body>
        <!--div class="app">
            <h1>PhoneGap</h1>
            <div id="deviceready" class="blink">
                <p class="event listening">Connecting to Device</p>
                <p class="event received">Device is Ready</p>
            </div>
        </div-->

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-fixed-top" id="nav">
            <div class="navbar-header">
                <a class="navbar-brand">Current Currency</a>
            </div>
        </nav>

        <header>
            <div class="container" style="padding-top:80px;">
            </div>
        </header>

        <div class="container">

            <div class="panel panel-default" id="target_panel">
                <div class="panel-body">
                    <div class="row">
                        <div class="left">
                            <table>
                                <tr>
                                    <td><span class="dollar_sign">$</span></td>
                                    <td><input type="number" class="input_newstyle" id="ifrom" oninput="tobeConvert(this.value);" value="1"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="right">
                            <table>
                                <tr>
                                    <td width="90"><span class="country_code"></span></td>
                                    <td rowspan="2"><button class="btn btn-default flag"></button></td>
                                </tr>
                                <tr>
                                    <td><span class="country_code_detail"></span></td>
                                </tr>
                            </table>
                        </div> 
                    </div>   
                          
                </div>
            </div>

            <hr>

            <div id="tiles"></div>

        </div>

        <!-- aboutModal -->
        <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><span class="glyphicon glyphicon-remove"></span></span></button>
                <h4 class="modal-title" id="myModalLabel">關於</h4>
              </div>
              <div class="modal-body">
                <h4>Current Currency</h4>
                <ul>
                  <li>All right reserved &copy; Seohea Production</li>
                  <li>Version 0.1</li>
                </ul>
                <span style="font-size:12px;">Currecny rate last updated at GMT+3 15:00</span>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-success" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span>&nbsp;關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Add -->
        <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><span class="icon icon-close"></span></span></button>
                <h4 class="modal-title" id="myModalLabel">Add Country</h4>
              </div>
              <div class="modal-body">
                <select id="country_select"></select>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal" onclick="add_country($('#country_select').val());"><span class="icon icon-plus"></span></button>
              </div>
            </div>
          </div>
        </div>

        <!-- Set -->
        <div class="modal fade" id="setModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><span class="icon icon-close"></span></span></button>
                <h4 class="modal-title" id="myModalLabel">Set Country</h4>
              </div>
              <div class="modal-body">
                <select id="set_country"></select>
                <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal" onclick="setcountry($('#set_country').val());"><span class="icon icon-check"></span></button>
                <hr>
                <input type="number" id="chartinterval" value="7"><span>days</span>
              </div>
              <div class="modal-footer">
                
              </div>
            </div>
          </div>
        </div>

        <!-- chart -->
        <div class="modal fade" id="chartModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><span class="icon icon-close"></span></span></button>
                <h4 class="modal-title" id="chartModaltitle"></h4>
              </div>
              <div class="modal-body">
                <div id="resultchart" style="height:340px; width:100%; padding:0px; margin:0px; display:block;"></div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal" onclick=""><span class="icon icon-check"></span></button>
              </div>
            </div>
          </div>
        </div>

        <nav class="navbar navbar-default navbar-fixed-bottom" id="bottomnav">
            <div class="container">
                <div class="btn-group btn-group-justified" role="group" aria-label="...">
                    <div class="btn-group" role="group">
                        <button class="btn btn-primary" type="button" data-toggle="modal" data-target="#addModal"><span class="icon icon-plus"></span></button>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-primary" type="button" data-toggle="modal" data-target="#setModal"><span class="icon icon-gear"></span></button>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-primary" type="button" onclick="clear_history();"><span class="icon icon-trash"></button>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-primary" type="button" onclick="buffer_getSpecificData();"><span class="icon icon-star"></button>
                    </div>
                </div>
            </div>
        </nav>

        <script id="hidden-template" type="text/x-custom-template">
            <div class="panel panel-default myPanel" style="display:none;" onclick="openChart($(this).closest('.panel').attr('id'));">
                <div class="panel-body">
                    <div class="row"> 
                        <div class="left">
                            <table>
                                <tr>
                                    <td><span class="dollar_sign">$</span></td>
                                    <td><input type="number" class="input_newstyle" disabled></td>
                                </tr>
                            </table>
                        </div>
                        <div class="right">
                            <table>
                                <tr>
                                    <td width="90"><span class="country_code"></span></td>
                                    <td rowspan="2"><button class="btn btn-default flag"></button></td>
                                </tr>
                                <tr>
                                    <td><span class="country_code_detail"></span></td>
                                </tr>
                            </table>
                        </div>
                    </div>                    
                </div>
            </div>
        </script>

        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript">
            app.initialize();
        </script>

    </body>
</html>
